<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.101.0"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta property="og:title" content="Part 1: DIY debugger in Golang"><meta name=description content="The first thing I do when I create a project is to create the debugger launch config at the .vscode folder. Debuggers help me to avoid …"><meta property="og:title" content="Part 1: DIY debugger in Golang"><meta property="og:description" content="The first thing I do when I create a project is to create the debugger launch config at the .vscode folder. Debuggers help me to avoid putting print statements and building the program again. I always wondered how a debugger can stop the program on the line number I want and be able to inspect variables. Debugger workings have always been dark magic for me. At last, I managed to learn dark art by reading several articles and groking the source code of delve."><meta property="og:type" content="article"><meta property="og:url" content="https://poonai.github.io/posts/how-debuggers-works-part1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-02T14:27:16+05:30"><meta property="article:modified_time" content="2021-09-02T14:27:16+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="Part 1: DIY debugger in Golang"><meta name=twitter:description content="The first thing I do when I create a project is to create the debugger launch config at the .vscode folder. Debuggers help me to avoid putting print statements and building the program again. I always wondered how a debugger can stop the program on the line number I want and be able to inspect variables. Debugger workings have always been dark magic for me. At last, I managed to learn dark art by reading several articles and groking the source code of delve."><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css><link rel=stylesheet type=text/css media=screen href=/css/all.css><title>Part 1: DIY debugger in Golang | Poonai's rant</title></head><body><header><div id=avatar><a href=https://poonai.github.io><img src=/img/avatar.jpg alt="Poonai's rant"></a></div><div id=titletext><h2 id=title><a href=https://poonai.github.io>Poonai's rant</a></h2></div><div id=title-description><p id=subtitle>Poonai is an independent software developer(Indie Hustler). கல்வி-அன்பு நிறைய உடையவர்கள் மேலோர்.</p><div id=social><nav><ul><li><a href=https://github.com/poonai><i title=Github class="icons fab fa-github"></i></a></li><li><a href=https://twitter.com/poonai_><i title=Twitter class="icons fab fa-twitter"></i></a></li></ul></nav></div></div></header><main><div class=post><div class=author></div><div class=post-header><div class=meta><div class=date><span class=day>02</span>
<span class=rest>Sep 2021</span></div></div><div class=matter><h1 class=title>Part 1: DIY debugger in Golang</h1></div></div><div class=markdown><p>The first thing I do when I create a project is to create the debugger launch config at the <code>.vscode</code> folder. Debuggers help me to avoid putting print statements and building the program again. I always wondered how a debugger can stop the program on the line number I want and be able to inspect variables. Debugger workings have always been dark magic for me. At last, I managed to learn dark art by reading several articles and groking the source code of <a href=https://github.com/go-delve target=_blank>delve</a>.</p><p>In this post, I&rsquo;ll talk about my learning while demystifying the dark art of debugger.</p><h2 id=problem-statement>Problem statement</h2><p>Let&rsquo;s define the problem statement before coding. I have a sample golang program that prints random ints every second. The goal which I want to achieve is that our debugger program should print <code>breakpoint hit</code> before our sample program prints the random integer.</p><p>Here is the sample program which prints random ints at every second.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ae81ff>1.</span> <span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2.</span> 
</span></span><span style=display:flex><span><span style=color:#ae81ff>3.</span> <span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span><span style=color:#ae81ff>4.</span>  <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>5.</span>  <span style=color:#e6db74>&#34;math/rand&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>6.</span>  <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>7.</span> )
</span></span><span style=display:flex><span><span style=color:#ae81ff>8.</span> 
</span></span><span style=display:flex><span><span style=color:#ae81ff>9.</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span><span style=color:#ae81ff>10.</span>     <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span><span style=color:#ae81ff>11.</span>         <span style=color:#a6e22e>variableToTrace</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Int</span>()
</span></span><span style=display:flex><span><span style=color:#ae81ff>12.</span>         <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>variableToTrace</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>13.</span>         <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>14.</span>     }
</span></span><span style=display:flex><span><span style=color:#ae81ff>15.</span> }
</span></span><span style=display:flex><span><span style=color:#ae81ff>16.</span> 
</span></span></code></pre></div><h2 id=solution>Solution</h2><p>Now that we know what we want to achieve. Let&rsquo;s go step by step and solve the problem statement.</p><p>The first step is to pause the sample program before it prints the random int. That means we have to set the breakpoint at line number 11.</p><p>To set the breakpoint at line number 11, we must gather the address of instruction at line number 11.</p><p>Some of us know from high school that all high-level language is converted into assembly language at the end. So, how do we find the address of the instruction in the assembly language?</p><p><figure><img src=/img/cathow.jpg alt=cathow></figure></p><p>Luckily, compilers add debug information along with the optimized assembly instruction on the output binary. Debug information contains information related to the mapping of assembly code to high-level language.
For Linux binaries, debug information is usually encoded in the DWARF format.</p><blockquote><p>DWARF is a debugging file format used by many compilers and debuggers to support source level debugging. It addresses the requirements of a number of procedural languages, such as C, C++, and Fortran, and is designed to be extensible to other languages. DWARF is architecture independent and applicable to any processor or operating system. It is widely used on Unix, Linux and other operating systems, as well as in stand-alone environments. source: <a href=http://www.dwarfstd.org/ target=_blank>http://www.dwarfstd.org/</a></p></blockquote><p>DWARF format can be parsed using objdump tool.</p><p>The below command will output all the addresses of the instruction and it&rsquo;s mapping to the line number and file name.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>objdump --dwarf<span style=color:#f92672>=</span>decodedline ./sample
</span></span></code></pre></div><p>objdump command will output similar to this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>File name                            Line number    Starting address    View    Stmt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/home/poonai/debugger-example/sample.go:
</span></span><span style=display:flex><span>sample.go                                      9            0x498200               x
</span></span><span style=display:flex><span>sample.go                                      9            0x498213               x
</span></span><span style=display:flex><span>sample.go                                     10            0x498221               x
</span></span><span style=display:flex><span>sample.go                                     11            0x498223               x
</span></span><span style=display:flex><span>sample.go                                     11            0x498225        
</span></span><span style=display:flex><span>sample.go                                     12            0x498233               x
</span></span><span style=display:flex><span>sample.go                                     12            0x498236        
</span></span><span style=display:flex><span>sample.go                                     13            0x4982be               x
</span></span><span style=display:flex><span>sample.go                                     13            0x4982cb        
</span></span><span style=display:flex><span>sample.go                                     11            0x4982cd               x
</span></span><span style=display:flex><span>sample.go                                     12            0x4982d2        
</span></span><span style=display:flex><span>sample.go                                      9            0x4982d9               x
</span></span><span style=display:flex><span>sample.go                                      9            0x4982de        
</span></span><span style=display:flex><span>sample.go                                      9            0x4982e0               x
</span></span><span style=display:flex><span>sample.go                                      9            0x4982e5               x
</span></span></code></pre></div><p>The output clearly states that <code>0x498223</code> is the starting address of line number 11 for sample.go file.</p><p>The next step is to pause the program at the address <code>0x498223</code></p><h2 id=trick-to-pause-the-program-execution>Trick to pause the program execution</h2><p>CPU will interrupt the program whenever it sees data int 3. So, we just have to rewrite the data at the address <code>0x498223</code> with the data []byte{0xcc} to pause the program.</p><blockquote><p>In computing and operating systems, a trap, also known as an exception or a fault, is typically a type of synchronous interrupt caused by an exceptional condition (e.g., breakpoint, division by zero, invalid memory access). source: wikipedia</p></blockquote><p>Does that mean we have to rewrite the binary at <code>0x498223</code>? No, we can write it using ptrace.</p><h2 id=ptrace-to-rescue>Ptrace to rescue</h2><blockquote><p>ptrace is a system call found in Unix and several Unix-like operating systems. By using ptrace (the name is an abbreviation of &ldquo;process trace&rdquo;) one process can control another, enabling the controller to inspect and manipulate the internal state of its target. ptrace is used by debuggers and other code-analysis tools, mostly as aids to software development. source:wikipedia</p></blockquote><p>ptrace is a syscall that allows us to rewrite the registers and write the data at the given address.</p><p>Now we know which address to pause and how to find the memory representing lines, and manipulate the memory of the sample program. So, let&rsquo;s put all this knowledge into action.</p><p>exec a process by setting Ptrace flag to true, so that we can use ptrace on the execed process.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>process</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#e6db74>&#34;./sample&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>SysProcAttr</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SysProcAttr</span>{<span style=color:#a6e22e>Ptrace</span>: <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>Setpgid</span>: <span style=color:#66d9ef>true</span>,    
</span></span><span style=display:flex><span><span style=color:#a6e22e>Foreground</span>: <span style=color:#66d9ef>false</span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>Stdout</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>Start</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The breakpoint can be set at <code>0x498223</code> by replacing the original data with int 3 (0xCC). This can be done by <code>PtracePokeData</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>setBreakpoint</span>(<span style=color:#a6e22e>pid</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>uintptr</span>) []<span style=color:#66d9ef>byte</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>PtracePeekData</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>data</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>PtracePokeData</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>addr</span>, []<span style=color:#66d9ef>byte</span>{<span style=color:#ae81ff>0xCC</span>}); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>data</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You must already be wondering why there is <code>PtracePeekData</code>, other than <code>PtracePokeData</code>. <code>PtracePeekData</code> allows us to read the memory at the given address. I&rsquo;ll explain later why I&rsquo;m reading the data at the address <code>0x498223</code>.</p><p>Since we set the breakpoint we&rsquo;ll continue the program and wait for the interrupt to happen. This can be done by <code>PtraceCont</code> and <code>Wait4</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>PtraceCont</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#ae81ff>0</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>     panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#75715e>// wait for the interupt to come.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>status</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>WaitStatus</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>Wait4</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>status</span>, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>nil</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>     panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;breakpoint hit&#34;</span>)
</span></span></code></pre></div><p>After the breakpoint hits, we need the program to continue as usual. Since we already modified the data at <code>0x498223</code> the program doesn&rsquo;t run as usual. So we need to replace the int 3 with original data.</p><p>Remember, we captured the original data at <code>0x498223</code> using <code>PtracePeekData</code> while setting the breakpoint. Let&rsquo;s just revert to the original data at <code>0x498223</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>PtracePokeData</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>data</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Just reverting to original data doesn&rsquo;t run the program as usual. Because the instruction at <code>0x498223</code> is already executed when breakpoint hits.
So, we want to tell the CPU to execute the instruction again at <code>0x498223</code>.</p><p><figure><img src=/img/registersintro.png alt=registers></figure></p><p>CPU executes the instruction that the instruction pointer points to. If you have studied microprocessors at university, you might remember.</p><p><figure><img src=/img/dejavu.jfif alt=dejavu></figure>So, that means if we set the instruction pointer to <code>0x498223</code> then the CPU will execute the instruction at <code>0x498223</code> again.CPU registers can be manipulated using<code>PtraceGetRegs</code> and <code>PtraceSetRegs</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>regs</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>PtraceRegs</span>{}
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>PtraceGetRegs</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>regs</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>   panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>regs</span>.<span style=color:#a6e22e>Rip</span> = uint64(<span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>PtraceSetRegs</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>regs</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>      panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span> }
</span></span></code></pre></div><p>Now that we modified the register, if we continue the program then it&rsquo;ll execute the normal flow. But we want to hit the breakpoint again, so we&rsquo;ll tell the ptrace to execute only the next instruction and set the breakpoint again. <code>PtraceSingleStep</code> allows us to execute only one instruction.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>resetBreakpoint</span>(<span style=color:#a6e22e>pid</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>originaldata</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>   <span style=color:#75715e>// revert back to original data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>PtracePokeData</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>originaldata</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// set the instruction pointer to execute the instruction again
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>regs</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>PtraceRegs</span>{}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>PtraceGetRegs</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>regs</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>regs</span>.<span style=color:#a6e22e>Rip</span> = uint64(<span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>PtraceSetRegs</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>regs</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>PtraceSingleStep</span>(<span style=color:#a6e22e>pid</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// wait for it&#39;s execution and set the breakpoint again
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>status</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>WaitStatus</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>Wait4</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>status</span>, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>nil</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setBreakpoint</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So far we have learned how to manipulate registers and set breakpoints. Let&rsquo;s put all these into a for loop and drive the program.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>pid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>Process</span>.<span style=color:#a6e22e>Pid</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>setBreakpoint</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#ae81ff>0x498223</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>PtraceCont</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#ae81ff>0</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// wait for the interrupt to come.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>status</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>WaitStatus</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>unix</span>.<span style=color:#a6e22e>Wait4</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>status</span>, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>nil</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;breakpoint hit&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// reset the breakpoint
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>resetBreakpoint</span>(<span style=color:#a6e22e>pid</span>, <span style=color:#ae81ff>0x498223</span>, <span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Phew, Finally we able to print <code>breakpoint hit</code> before our sample program prints random int.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>breakpoint hit
</span></span><span style=display:flex><span>6129484611666145821
</span></span><span style=display:flex><span>breakpoint hit
</span></span><span style=display:flex><span>4037200794235010051
</span></span><span style=display:flex><span>breakpoint hit
</span></span><span style=display:flex><span>3916589616287113937
</span></span><span style=display:flex><span>breakpoint hit
</span></span><span style=display:flex><span>6334824724549167320
</span></span><span style=display:flex><span>breakpoint hit
</span></span><span style=display:flex><span>605394647632969758
</span></span><span style=display:flex><span>breakpoint hit
</span></span><span style=display:flex><span>1443635317331776148
</span></span><span style=display:flex><span>breakpoint hit
</span></span><span style=display:flex><span>894385949183117216
</span></span></code></pre></div><p>You can find the full source code at <a href=https://github.com/poonai/debugger-example target=_blank>https://github.com/poonai/debugger-example</a></p><p>That&rsquo;s all for now. Hope you folks learned something new. In the next post, I&rsquo;ll write how to extract values from the variables by reading DWARF info. You can follow me on <a href=https://twitter.com/poonai_ target=_blank>Twitter</a> to get notified about part 2.</p></div></div></div></main><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-206886735-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>